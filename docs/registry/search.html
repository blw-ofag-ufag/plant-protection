<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produktsuche | LINDAS</title>

  <!-- Google Fonts: Poppins & Material Symbols -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />

  <!-- Main stylesheet -->
  <link rel="stylesheet" href="styles.css">
  <style>
    /* -------------------------------------- */
    /* --- Search Page Specific Styles --- */
    /* -------------------------------------- */

    .main-content {}

    .page-content {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 2rem;
      align-items: start;
    }

    .page-content:not(.has-company-filter) {
      grid-template-columns: 1fr;
    }
    
    .company-sidebar:empty { display: none; }

    .company-sidebar {
      position: sticky;
      top: 100px;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .filter-bar {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .product-listing {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    }

    .company-info-card .company-info-label {
      font-size: 0.9rem;
      color: var(--text-tertiary);
      margin-bottom: 0.25rem;
    }
    .company-info-card .company-name-header {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1rem;
    }
    .company-info-card .company-address {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    a.product-card {
      text-decoration: none; color: inherit; background-color: var(--surface-1);
      border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 1.5rem;
      display: flex; flex-direction: column; justify-content: space-between;
      transition: all var(--transition-speed) ease;
    }
    a.product-card:hover {
      transform: translateY(-5px); border-color: var(--primary);
      box-shadow: 0 10px 30px rgba(0, 188, 212, 0.2);
    }
    
    .card-header {
      display: flex; justify-content: space-between; align-items: flex-start;
      gap: 1rem; margin-bottom: 0.25rem;
    }
    .card-header h3 {
      font-size: 1.25rem; color: var(--text-primary); margin-bottom: 0;
    }
    .card-admission-number {
      font-family: var(--font-monospace); font-weight: 500; color: var(--text-secondary);
      background-color: var(--background); padding: 0.25rem 0.5rem;
      border: 1px solid var(--border-color); border-radius: 6px;
      white-space: nowrap; flex-shrink: 0;
    }
    
    .product-card .company-name {
      color: var(--text-secondary); margin-bottom: 1rem; cursor: pointer;
      transition: color var(--transition-speed); display: inline-block;
    }
    .product-card .company-name:hover {
      color: var(--primary); text-decoration: underline;
    }
    .product-card .chip { cursor: pointer; }
    
    .chip-set { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .chip {
      display: inline-flex; align-items: center; gap: 0.5rem;
      padding: 0.3rem 0.8rem; border-radius: 20px; background-color: var(--surface-2);
      font-size: 0.8rem; font-weight: 500; color: var(--text-secondary);
      transition: all var(--transition-speed); cursor: pointer;
    }
    .chip:hover { background-color: rgba(255, 255, 255, 0.15); }
    .chip.active {
      background-color: var(--primary); color: var(--background); font-weight: 600;
    }
    .chip.disabled {
      opacity: 0.4; pointer-events: none; background-color: var(--surface-1);
    }

    /* FIX: The border-top is removed from this container */
    .reset-filters-container {
      padding-top: 1.5rem;
    }
    
    /* NEW: Styling for the search term reminder message */
    .search-term-reminder {
        color: var(--text-secondary);
        margin-bottom: 1.5rem;
    }
    .search-term-reminder strong {
        color: var(--text-primary);
        font-weight: 500;
    }
    
    .reset-filters-btn {
      display: inline-flex; align-items: center; gap: 0.5rem;
      padding: 0.5rem 1rem; border: 1px solid var(--text-tertiary);
      color: var(--text-tertiary); background-color: transparent;
      border-radius: var(--border-radius); font-family: inherit;
      font-size: 0.9rem; cursor: pointer; transition: all var(--transition-speed);
    }
    .reset-filters-btn:hover {
      background-color: var(--surface-2); color: var(--text-primary); border-color: var(--text-primary);
    }

    .no-results-container {
      grid-column: 1 / -1; text-align: center; padding: 4rem 2rem;
      background-color: var(--surface-1); border-radius: var(--border-radius);
    }
    .no-results-container p { color: var(--text-secondary); margin-bottom: 1.5rem; }

  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-content">
      <div class="site-title">
        <span class="material-symbols-outlined">science</span>
        <span>LinPSM</span>
      </div>
      <form class="search-form" id="search-form" role="search">
        <span class="material-symbols-outlined search-icon">search</span>
        <input type="search" id="search-input" placeholder="Produkt nach Name, Zulassungsnummer oder Firma suchen..." autocomplete="off">
      </form>
    </div>
  </header>

  <div class="content-wrapper">
    <div id="loading" class="loading-container">
      <div class="spinner"></div>
      <p>Lade Produktdaten von LINDAS</p>
    </div>

    <div class="page-content hidden" id="page-content">
      <aside class="company-sidebar" id="company-sidebar"></aside>
      <main class="main-content">
        <h1 id="page-title">Produktsuche</h1>
        <div class="filter-bar" id="filter-bar">
          <div id="reset-button-container"></div>
          <div class="chip-set" id="class-filters"></div>
        </div>
        <div class="product-listing" id="product-listing"></div>
      </main>
    </div>
  </div>

  <footer class="site-footer">
    <p>
      Diese Seite ist ein Demoprojekt des Bundesamtes für Landwirtschaft (BLW).
      Die Daten werden über die <a href="https://lindas.admin.ch" target="_blank" rel="noopener">LINDAS-Plattform</a> bereitgestellt.
      Den Quellcode und weitere Informationen finden Sie auf <a href="https://github.com/blw-ofag-ufag/plant-protection" target="_blank" rel="noopener">GitHub</a>.
    </p>
  </footer>

  <script>
    (async () => {
      const $loading = document.getElementById('loading');
      const $pageContent = document.getElementById('page-content');
      const $productListing = document.getElementById('product-listing');
      const $classFilters = document.getElementById('class-filters');
      const $searchInput = document.getElementById('search-input');
      const $searchForm = document.getElementById('search-form');
      const $companySidebar = document.getElementById('company-sidebar');
      const $pageTitle = document.getElementById('page-title');
      const $resetButtonContainer = document.getElementById('reset-button-container');

      let allProducts = [];
      let allProductClasses = new Map();

      const fetchSparql = async (q) => {
        const res = await fetch('https://lindas.admin.ch/query', { method: 'POST', headers: { 'Content-Type': 'application/sparql-query', 'Accept': 'application/sparql-results+json' }, body: q });
        if (!res.ok) throw new Error(`SPARQL Query Failed: ${res.status} ${res.statusText}`);
        return res.json();
      };

      const debounce = (func, delay) => {
        let timeout;
        return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func(...args), delay); };
      };

      const renderProductCard = (product) => {
        const productUrl = `index.html?id=${encodeURIComponent(product.federalAdmissionNumber)}`;
        const classChips = product.classes.map(c => `<span class="chip" data-class-slug="${c.slug}">${c.label}</span>`).join('');
        return `<a href="${productUrl}" class="product-card"><div><div class="card-header"><h3>${product.name}</h3><span class="card-admission-number">${product.federalAdmissionNumber}</span></div><p class="company-name" data-company-slug="${product.companySlug}">${product.companyName}</p></div><div class="chip-set">${classChips}</div></a>`;
      };
      
      const renderProducts = (products) => {
        $productListing.innerHTML = products.length === 0 
          ? `<div class="no-results-container"><p>Für die aktuelle Auswahl wurden keine Produkte gefunden.</p><button class="reset-filters-btn" id="clear-filters-in-msg"><span class="material-symbols-outlined">filter_list_off</span>Alle Filter zurücksetzen</button></div>` 
          : products.map(renderProductCard).join('');
      };

      const renderCompanyCard = (company) => {
          if (!company || !company.name) {
              $companySidebar.innerHTML = '';
              $pageContent.classList.remove('has-company-filter');
              return;
          }
          const address = [company.street?.value, company.postal?.value, company.locality?.value].filter(Boolean).join('<br>');
          $companySidebar.innerHTML = `<div class="card company-info-card"><p class="company-info-label">Produkte der Firma</p><div class="company-name-header">${company.name.value}</div>${address ? `<p class="company-address">${address}</p>` : ''}</div>`;
          $pageContent.classList.add('has-company-filter');
      };
      
      const renderFilterUI = (productsForFilterLogic) => {
          const urlParams = new URLSearchParams(window.location.search);
          const searchTerm = urlParams.get('search');
          const activeSlugs = (urlParams.get('class') || '').split(',').filter(Boolean);
          
          const availableClassSlugs = new Set(productsForFilterLogic.flatMap(p => p.classes.map(c => c.slug)));
          $classFilters.querySelectorAll('.chip[data-class-slug]').forEach(chip => {
              const slug = chip.dataset.classSlug;
              const isActive = activeSlugs.includes(slug);
              chip.classList.toggle('active', isActive);
              chip.classList.toggle('disabled', !isActive && !availableClassSlugs.has(slug));
          });
          
          const isFilterActive = !!urlParams.get('company') || !!searchTerm || activeSlugs.length > 0;
          let uiHtml = '';
          if (isFilterActive) {
              if (searchTerm) {
                  uiHtml += `<span class="search-term-reminder">Suchresultate für "<strong>${searchTerm}</strong>"</span>`;
              }
              uiHtml += `<div class="reset-filters-container"><button class="reset-filters-btn" id="reset-filters-btn"><span class="material-symbols-outlined">filter_list_off</span>Filter zurücksetzen</button></div>`;
          }
          $resetButtonContainer.innerHTML = uiHtml;
      };

      const applyFilters = async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const searchTerm = (urlParams.get('search') || '').toLowerCase();
        const selectedClassSlugs = (urlParams.get('class') || '').split(',').filter(Boolean);
        const companySlug = urlParams.get('company');

        let intermediateProducts = allProducts.filter(p => 
            (!companySlug || p.companySlug === companySlug) &&
            (!searchTerm || p.name.toLowerCase().includes(searchTerm) || p.federalAdmissionNumber.toLowerCase().includes(searchTerm) || p.companyName.toLowerCase().includes(searchTerm))
        );
        
        const finalProducts = selectedClassSlugs.length > 0 
            ? intermediateProducts.filter(p => selectedClassSlugs.every(slug => p.classes.some(c => c.slug === slug))) 
            : intermediateProducts;
        
        renderFilterUI(finalProducts);
        renderProducts(finalProducts);
        
        const count = finalProducts.length;
        $pageTitle.textContent = count === 1 ? '1 Produkt gefunden' : `${count} Produkte gefunden`;

        if (companySlug && intermediateProducts.length > 0) {
            const companyIri = intermediateProducts[0].companyIri;
            const sparqlCompany = `PREFIX schema:<http://schema.org/> SELECT * WHERE { VALUES ?c { <${companyIri}> } ?c schema:legalName ?name . OPTIONAL { ?c schema:address ?a . ?a schema:streetAddress ?street ; schema:postalCode ?postal ; schema:addressLocality ?locality . } }`;
            try {
                const companyJ = await fetchSparql(sparqlCompany);
                renderCompanyCard(companyJ.results.bindings[0]);
            } catch (e) {
                console.error("Could not fetch company data", e);
                renderCompanyCard(null);
            }
        } else {
            renderCompanyCard(null);
        }
      };

      const handleProductListingClick = (e) => {
          const companyEl = e.target.closest('.company-name[data-company-slug]');
          const chipEl = e.target.closest('.chip[data-class-slug]');

          if (companyEl) {
              e.preventDefault();
              const urlParams = new URLSearchParams(window.location.search);
              urlParams.set('company', companyEl.dataset.companySlug);
              window.history.pushState({}, '', `${window.location.pathname}?${urlParams.toString()}`);
              applyFilters();
          } else if (chipEl) {
              e.preventDefault();
              const urlParams = new URLSearchParams(window.location.search);
              const activeSlugs = new Set((urlParams.get('class') || '').split(',').filter(Boolean));
              activeSlugs.add(chipEl.dataset.classSlug);
              urlParams.set('class', [...activeSlugs].join(','));
              window.history.pushState({}, '', `${window.location.pathname}?${urlParams.toString()}`);
              applyFilters();
          }
      };

      const handleClassFilterClick = (e) => {
        const chip = e.target.closest('.chip[data-class-slug]');
        if (!chip) return;
        const urlParams = new URLSearchParams(window.location.search);
        const activeSlugs = (urlParams.get('class') || '').split(',').filter(Boolean);
        const index = activeSlugs.indexOf(chip.dataset.classSlug);
        if (index > -1) activeSlugs.splice(index, 1);
        else activeSlugs.push(chip.dataset.classSlug);
        if (activeSlugs.length > 0) urlParams.set('class', activeSlugs.join(','));
        else urlParams.delete('class');
        window.history.pushState({}, '', `${window.location.pathname}?${urlParams.toString()}`);
        applyFilters();
      };
      
      const handleClearFilters = (e) => {
          if (!e.target.closest('#reset-filters-btn') && !e.target.closest('#clear-filters-in-msg')) return;
          window.history.pushState({}, '', window.location.pathname);
          $searchInput.value = '';
          applyFilters();
      };

      const handleSearchInput = () => {
        const urlParams = new URLSearchParams(window.location.search);
        if ($searchInput.value) urlParams.set('search', $searchInput.value);
        else urlParams.delete('search');
        window.history.pushState({}, '', `${window.location.pathname}?${urlParams.toString()}`);
        applyFilters();
      };

      const main = async () => {
        try {
          const sparqlQuery = `PREFIX schema: <http://schema.org/> PREFIX : <https://agriculture.ld.admin.ch/plant-protection/> SELECT * WHERE { GRAPH <https://lindas.admin.ch/foag/plant-protection> { ?product a :Product ; schema:name ?name ; a ?class ; :federalAdmissionNumber ?federalAdmissionNumber ; :hasPermissionHolder ?company . ?class rdfs:subClassOf+ :Product ; schema:name ?className . FILTER(LANG(?className)="de") } ?company schema:legalName ?companyName . }`;
          const { results } = await fetchSparql(sparqlQuery);
          
          const productsMap = new Map();
          results.bindings.forEach(item => {
              const id = item.federalAdmissionNumber.value;
              if (!productsMap.has(id)) {
                  productsMap.set(id, { federalAdmissionNumber: id, name: item.name.value, companyName: item.companyName.value, companySlug: item.company.value.split('/').pop(), companyIri: item.company.value, classes: [] });
              }
              const product = productsMap.get(id);
              const classUri = item.class.value, className = item.className.value;
              if (!product.classes.some(c => c.uri === classUri)) product.classes.push({ uri: classUri, label: className, slug: classUri.split('/').pop() });
              if (!allProductClasses.has(classUri) && !className.includes('Produkt')) allProductClasses.set(classUri, { label: className, slug: classUri.split('/').pop() });
          });
          allProducts = [...productsMap.values()];

          $classFilters.innerHTML = [...allProductClasses.values()].sort((a,b) => a.label.localeCompare(b.label, 'de')).map(({ label, slug }) => `<span class="chip" data-class-slug="${slug}">${label}</span>`).join('');
          $searchInput.value = new URLSearchParams(window.location.search).get('search') || '';
          
          await applyFilters();

          $loading.classList.add('hidden');
          $pageContent.classList.remove('hidden');
          $pageContent.classList.add('visible');

          $classFilters.addEventListener('click', handleClassFilterClick);
          $productListing.addEventListener('click', handleProductListingClick);
          $searchForm.addEventListener('submit', (e) => e.preventDefault());
          $searchInput.addEventListener('input', debounce(handleSearchInput, 300));
          document.body.addEventListener('click', handleClearFilters);
        } catch (err) {
          console.error(err);
          $loading.innerHTML = `<p class="error" style="color: #ff5252;">${err.message}</p>`;
        }
      };
      main();
    })();
  </script>
</body>
</html>